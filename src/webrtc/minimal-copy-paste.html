<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/src/common/set-title.js"></script>
  <link rel="stylesheet" href="/src/webrtc/minimal-copy-paste.css">
</head>
<body>
  <h2>Minimal WebRTC í…ŒìŠ¤íŠ¸</h2>
  <p class="sub-text">
    Signaling (WebSocket) ì—°ê²° ì‹œ Offer/Answer/ICE í›„ë³´ê°€ ìë™ ì „ì†¡/ìˆ˜ì‹ ë©ë‹ˆë‹¤. ë¯¸ì—°ê²° ì‹œ ìˆ˜ë™ ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
  </p>

  <!-- UI/UX ê¸°ë³¸ ìš”ì†Œ -->
  <div>
    <div class="row">
      <div class="col">
        <h3>Local</h3>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>
      <div class="col">
        <h3>Remote</h3>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
    </div>

    <div class="row">
      <button id="startCamera">ğŸ¥ Start Camera</button>
    </div>
  </div>

  <!-- WebSocket signaling controls -->
  <div class="panel">
    <h3>WebSocket signaling</h3>

    <label>
      WS URL:
      <input id="wsUrl" type="text" style="width: 360px;" value="wss://localhost:3001" />
    </label>
    <button id="connectWs">ğŸ”Œ Connect WS</button>
    <button id="disconnectWs">âŒ Disconnect WS</button>
    <span id="wsStatus">disconnected</span>
  </div>

  <!-- ìˆ˜ë™ WebRTC ì—°ê²° -->
  <div class="panel">
    <h3>ìˆ˜ë™ WebRTC ì—°ê²°</h3>
    <p class="sub-text">
      - Aì—ì„œ â€œCreate Offerâ€ í´ë¦­ â†’ Aì˜ SDPì— Offer í…ìŠ¤íŠ¸ ìƒì„±<br/>
      - Aì˜ SDP Offer í…ìŠ¤íŠ¸ë¥¼ Bì˜ SDPì— ë¶™ì—¬ë„£ê³  â€œCreate Answerâ€ í´ë¦­ â†’ Bì˜ SDPì— Answer í…ìŠ¤íŠ¸ ìƒì„±<br/>
      - Bì˜ SDP Answer í…ìŠ¤íŠ¸ë¥¼ Aì˜ SDPì— ë¶™ì—¬ë„£ê³  â€œSet Remote Answerâ€ í´ë¦­ â†’ Aì˜ ICE Candidatesì— í…ìŠ¤íŠ¸ ìƒì„±<br/>
      - Aì˜ ICE Candidates í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬ â†’ Bì˜ Remote ICE Candidatesì— ë¶™ì—¬ë„£ê³  â€œAdd Remote ICE Candidatesâ€ í´ë¦­<br/>
    </p>

    <div class="row">
      <button id="createOffer" title="RTCPeerConnectionì„ ë§Œë“¤ê³ , ë‚´ ì—°ê²° ì €ì¥ë¥¼ ë‹´ì€ Offer(SDP)ë¥¼ ìƒì„±í•´ ìƒëŒ€ì—ê²Œ ë³´ë‚´ê¸° ìœ„í•œ ì´ë²¤íŠ¸">Create Offer</button>
      <button id="createAnswer" title="ìƒëŒ€ê°€ ë³´ë‚¸ Offerë¥¼ ë°›ì•„ì„œ, ë‚´ê°€ ì—°ê²°í•  ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ëŠ” Answer(SDP)ë¥¼ ìƒì„±í•˜ëŠ” ì´ë²¤íŠ¸">Create Answer</button>
      <button id="setRemoteAnswer" title="ìƒëŒ€ê°€ ë³´ë‚¸ Answer(SDP)ë¥¼ ë‚´ RTCPeerConnectionì— ì ìš©í•˜ëŠ” ì´ë²¤íŠ¸">Set Remote Answer</button>
      <button id="addRemoteCandidates">Add Remote ICE Candidates</button>
    </div>

    <div class="row">
      <div class="col">
        <h4>SDP (Offer/Answer)</h4>
        <textarea id="sdpBox"></textarea>
      </div>
      <div class="col">
        <h4>ICE Candidates</h4>
        <textarea id="localCandidatesBox"></textarea>
      </div>
      <div class="col">
        <h4>Remote ICE Candidates</h4>
        <textarea id="remoteCandidatesBox"></textarea>
      </div>
    </div>
  </div>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    const startBtn = document.getElementById('startCamera');
    const createOfferBtn = document.getElementById('createOffer');
    const createAnswerBtn = document.getElementById('createAnswer');
    const setRemoteAnswerBtn = document.getElementById('setRemoteAnswer');
    const addRemoteCandidatesBtn = document.getElementById('addRemoteCandidates');

    const sdpBox = document.getElementById('sdpBox');
    const localCandidatesBox = document.getElementById('localCandidatesBox');
    const remoteCandidatesBox = document.getElementById('remoteCandidatesBox');

    let pc;
    let localStream;

    const configuration = {
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    // WebSocket signaling
    let connectWsBtn, disconnectWsBtn, wsStatusSpan, wsUrlInput;
    let ws = null;

    function setWsStatus(connected) {
      wsStatusSpan.textContent = connected ? 'connected' : 'disconnected';
      wsStatusSpan.style.color = connected ? 'green' : 'red';
    }

    // DOMì´ ì¤€ë¹„ëœ í›„ì— ìš”ì†Œ ì„ íƒ ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    window.addEventListener('DOMContentLoaded', () => {
      connectWsBtn = document.getElementById('connectWs');
      disconnectWsBtn = document.getElementById('disconnectWs');
      wsStatusSpan = document.getElementById('wsStatus');
      wsUrlInput = document.getElementById('wsUrl');
    
      connectWsBtn.onclick = () => {
        if (ws && ws.readyState === WebSocket.OPEN) return;
        try {
          const targetUrl = (wsUrlInput.value || '').trim() || `wss://${location.host}`;
          ws = new WebSocket(targetUrl);
          ws.onopen = () => setWsStatus(true);
          ws.onclose = () => setWsStatus(false);
          ws.onerror = () => setWsStatus(false);
    
          ws.onmessage = async (msg) => {
            try {
              const data = JSON.parse(msg.data);
              ensurePC();
              if (data.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                if (ws && ws.readyState === WebSocket.OPEN) {
                  ws.send(JSON.stringify({ type: 'answer', answer: pc.localDescription }));
                } else {
                  sdpBox.value = JSON.stringify(pc.localDescription);
                }
              }
              if (data.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
              }
              if (data.type === 'candidate') {
                try {
                  await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (err) {
                  console.error('Error adding ICE candidate:', err);
                }
              }
            } catch (e) {
              console.error('WS message handling error:', e);
            }
          };
        } catch (e) {
          alert('WS ì—°ê²° ì‹¤íŒ¨: ' + e.message);
        }
      };
    
      disconnectWsBtn.onclick = () => {
        if (ws) {
          try { ws.close(); } catch {}
          ws = null;
          setWsStatus(false);
        }
      };
    });

    function ensurePC() {
      if (!pc) {
        pc = new RTCPeerConnection(configuration);

        const remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;
        pc.ontrack = (event) => {
          event.streams[0].getTracks().forEach((t) => remoteStream.addTrack(t));
        };

        // ë¡œì»¬ ICE í›„ë³´: ìˆ˜ë™ í…ìŠ¤íŠ¸ + WS ì „ì†¡ ë³‘í–‰
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            // ìˆ˜ë™ êµí™˜ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ëˆ„ì 
            localCandidatesBox.value += JSON.stringify(event.candidate) + '\n';
            // WS ì—°ê²° ì‹œ ìë™ ì „ì†¡
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({ type: 'candidate', candidate: event.candidate }));
            }
          }
        };

        pc.oniceconnectionstatechange = () => {
          console.log('ICE state:', pc.iceConnectionState);
        };
      }
    }

    // ì¹´ë©”ë¼ ì‹œì‘
    startBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
        ensurePC();
        localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));
      } catch (e) {
        alert('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Offer ìƒì„±: ìˆ˜ë™/WS ë³‘í–‰
    createOfferBtn.onclick = async () => {
      try {
        ensurePC();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    
        // í•­ìƒ í…ìŠ¤íŠ¸ ë°•ìŠ¤ì— ì±„ìš°ê¸°
        sdpBox.value = JSON.stringify(pc.localDescription);
    
        // WS ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ ì „ì†¡
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'offer', offer: pc.localDescription }));
        }
      } catch (e) {
        alert('Offer ìƒì„± ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Answer ìƒì„±: ìˆ˜ë™/WS ë³‘í–‰
    createAnswerBtn.onclick = async () => {
      try {
        ensurePC();
        const remoteOffer = JSON.parse(sdpBox.value.trim());
        await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
    
        // í•­ìƒ í…ìŠ¤íŠ¸ ë°•ìŠ¤ì— ì±„ìš°ê¸°
        sdpBox.value = JSON.stringify(pc.localDescription);
    
        // WS ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¶”ê°€ë¡œ ì „ì†¡
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'answer', answer: pc.localDescription }));
        }
      } catch (e) {
        alert('Answer ìƒì„± ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Remote Answer ìˆ˜ë™ ì ìš©
    setRemoteAnswerBtn.onclick = async () => {
      try {
        const remoteAnswer = JSON.parse(sdpBox.value.trim());
        await pc.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
        alert('Remote Answer ì ìš© ì™„ë£Œ!');
      } catch (e) {
        alert('Remote Answer ì ìš© ì‹¤íŒ¨: ' + e.message);
      }
    };

    // Remote ICE candidates ìˆ˜ë™ ì ìš©
    addRemoteCandidatesBtn.onclick = async () => {
      try {
        const lines = remoteCandidatesBox.value
          .split('\n')
          .map((l) => l.trim())
          .filter((l) => !!l);

        for (const line of lines) {
          const candidateObj = JSON.parse(line);
          await pc.addIceCandidate(new RTCIceCandidate(candidateObj));
        }
        alert('Remote ICE candidates ì ìš© ì™„ë£Œ!');
      } catch (e) {
        alert('ICE candidates ì ìš© ì‹¤íŒ¨: ' + e.message);
      }
    };
  </script>
</body>
</html>