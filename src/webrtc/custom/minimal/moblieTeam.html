<!DOCTYPE html>
<html lang="ko">
<head>
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
      }
    }
  </script>
  <script src="/src/webrtc/js/common/set-title.js"></script>
  <script src="/src/webrtc/js/common/utils.js"></script>
  <script src="/src/webrtc/js/common/CallManager.js"></script>
  <script src="/src/webrtc/js/common/SignalingService.js"></script>
  <link rel="stylesheet" href="/src/webrtc/css/main.css">
</head>
<body>
  <div id='container'>
    <div class="status-pill">
      <div><span id="statusText">WAITING</span></div>
    </div>
  
    <div class="split-container">
      <div class="video-box">
        <div class="label">상대방 (Remote)</div>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
      <div class="video-box">
        <div class="label">나 (Local)</div>
        <video id="localVideo" autoplay playsinline></video>
      </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner"></div>
      <div class="loading-text">연결 중...</div>
    </div>
  
    <div class="control-bar">
      <button id="startCallBtn" class="btn-primary" onclick="startCall()" style="display:none">통화 시작</button>
      <button id="receiveCallBtn" class="btn-primary" onclick="receiveCall()" style="display:none">전화 받기</button>
      <button id="endCallBtn" class="btn-danger" onclick="endCall()" style="display:none">통화 종료</button>
      <button id="toggleCameraBtn" class="btn-secondary" onclick="callManager.toggleMedia('video')" style="display:none">카메라 On</button>
      <button id="toggleAudioBtn" class="btn-secondary" onclick="callManager.toggleMedia('audio')" style="display:none">마이크 On</button>
      <button id="retryBtn" class="btn-primary" onclick="init()" style="display:none">다시 연결</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'firebase/app';
    import { getDatabase, ref, set, onValue, push, onChildAdded, remove } from 'firebase/database';

    const firebaseConfig = {
      apiKey: "AIzaSyAZ6FOlTH6RxLa8crgkaJeFj0wN4n0RkkA",
      authDomain: "webrtc-test-2c0e5.firebaseapp.com",
      databaseURL: "https://webrtc-test-2c0e5-default-rtdb.firebaseio.com",
      projectId: "webrtc-test-2c0e5",
      storageBucket: "webrtc-test-2c0e5.appspot.com",
      messagingSenderId: "1066252661216",
      appId: "1:1066252661216:web:2521c2b6c2b6c2b6c2b6c2",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Bridge Firebase to global for SignalingService
    window.dbRef = ref;
    window.onDBValue = onValue;
    window.onDBChildAdded = onChildAdded;
    window.setDB = set;
    window.pushDB = push;
    window.removeDB = remove;

    const signaling = new FirebaseSignaling(db, 'calls/room1');
    const callManager = new CallManager(
      { iceServers: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] } },
      (state) => updateUi(state),
      (candidate) => signaling.send({ type: 'candidate', role: callManager.role, candidate: candidate.toJSON() })
    );

    signaling.onMessage = async (data) => {
      if (data.type === 'offer' && !callManager.pc.remoteDescription) {
        const answer = await callManager.handleOffer(data.offer);
        signaling.send({ type: 'answer', answer: { type: answer.type, sdp: answer.sdp } });
      } else if (data.type === 'answer') {
        await callManager.handleAnswer(data.answer);
      } else if (data.type === 'candidate') {
        // 내 역할이 아닌 후보자만 추가
        if (data.role !== callManager.role) {
          await callManager.addIceCandidate(data.candidate);
        }
      }
    };

    function updateUi(state) {
      document.getElementById('statusText').textContent = CALL_STATUS[state].label;
      const btns = ['startCallBtn', 'receiveCallBtn', 'endCallBtn', 'toggleCameraBtn', 'toggleAudioBtn', 'retryBtn'];
      btns.forEach(id => document.getElementById(id).style.display = 'none');
      document.getElementById('loadingOverlay').style.display = (state === CALL_STATUS.CONNECTING.id) ? 'flex' : 'none';

      if (state === CALL_STATUS.IDLE.id) {
        ['startCallBtn', 'receiveCallBtn', 'toggleCameraBtn', 'toggleAudioBtn'].forEach(id => document.getElementById(id).style.display = 'block');
      } else if (state === CALL_STATUS.CONNECTING.id || state === CALL_STATUS.CONNECTED.id) {
        ['endCallBtn', 'toggleCameraBtn', 'toggleAudioBtn'].forEach(id => document.getElementById(id).style.display = 'block');
      } else if (state === CALL_STATUS.ERROR.id) {
        document.getElementById('retryBtn').style.display = 'block';
      }
    }

    window.startCall = async () => {
      callManager.role = 'caller';
      callManager.ensurePC(document.getElementById('remoteVideo'));
      await signaling.connect();
      const offer = await callManager.createOffer();
      signaling.send({ type: 'offer', offer: { type: offer.type, sdp: offer.sdp } });
    };

    window.receiveCall = async () => {
      callManager.role = 'callee';
      callManager.ensurePC(document.getElementById('remoteVideo'));
      await signaling.connect();
    };

    window.endCall = async () => {
      await signaling.send({ type: 'leave' });
      callManager.closePC();
      callManager.stopMedia();
      document.getElementById('localVideo').srcObject = null;
      callManager.state = CALL_STATUS.DISCONNECTED.id;
    };

    async function init() {
      try {
        await callManager.getMediaStream(document.getElementById('localVideo'));
        callManager.state = CALL_STATUS.IDLE.id;
      } catch (e) {
        handleError(e, init);
      }
    }

    window.init = init;
    window.onload = init;
  </script>
</body>
</html>