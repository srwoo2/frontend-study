<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/src/webrtc/js/common/set-title.js"></script>
  <script src="/src/webrtc/js/common/utils.js"></script>
</head>
  <style>
    :root {
      --bg-color: #202124;
      --text: #ffffff;
    }
  </style>
</head>
<body>
  <div id="container">
    <div class="status-pill">
      <div>Local: <span id="localStatus">IDLE</span></div>
      <div style="margin-left: 10px; padding-left: 10px; border-left: 1px solid #555;">Remote: <span id="remoteStatus">IDLE</span></div>
    </div>

    <div class="split-container">
      <div class="video-box">
        <div class="label">Remote</div>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
      <div class="video-box">
        <div class="label">Local</div>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>
    </div>

    <div class="control-bar">
      <button id="startCallBtn" class="btn-primary" onclick="startCall()">통화 연결</button>
      <button id="endCallBtn" class="btn-danger" onclick="endCall(); disconnectWss();" disabled>통화 종료</button>
      <button id="toggleCameraBtn" class="btn-secondary" onclick="toggleCamera()" disabled>카메라</button>
      <button id="toggleAudioBtn" class="btn-secondary" onclick="toggleAudio()" disabled>오디오</button>
      <button class="btn-secondary" onclick="document.getElementById('manualPanel').style.display = 'block'">수동 설정</button>
    </div>

    <div id="manualPanel" class="panel" style="display: none; position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; background: rgba(32, 33, 36, 0.95); z-index: 100; overflow-y: auto; border: 1px solid #444; color: #fff; padding: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; margin-bottom: 15px; padding-bottom: 10px;">
        <h3 style="margin: 0;">수동 WebRTC 연결</h3>
        <button class="btn-secondary" style="height: 32px; padding: 0 16px;" onclick="document.getElementById('manualPanel').style.display = 'none'">닫기</button>
      </div>
      
      <p class="sub-text" style="color: #aaa;">
        - A에서 “Create Offer” 클릭 → A의 SDP에 Offer 텍스트 생성 및 복사<br/>
        - A의 SDP Offer → B의 SDP에 붙여넣고 “Create Answer” 클릭 → B의 SDP에 Answer 텍스트 생성 및 복사<br/>
        - B의 SDP Answer → A의 SDP에 붙여넣고 “Set Remote Answer” 클릭 → A의 ICE Candidates에 텍스트 생성 및 복사<br/>
        - A의 ICE Candidates → B의 Remote ICE Candidates에 붙여넣고 “Add Remote ICE Candidates” 클릭<br/>
      </p>

      <div class="row" style="margin: 20px 0;">
        <button class="btn-primary" style="height: 40px;" onclick="handleCreateOffer()">Create Offer</button>
        <button id="createAnswer" class="btn-primary" style="height: 40px;" onclick="handleCreateAnswer()">Create Answer</button>
        <button id="setRemoteAnswer" class="btn-primary" style="height: 40px;" onclick="handleSetRemoteAnswer()">Set Remote Answer</button>
        <button id="addRemoteCandidates" class="btn-primary" style="height: 40px;" onclick="handleAddRemoteCandidates()">Add Remote ICE Candidates</button>
      </div>

      <div class="row">
        <div class="col">
          <h4>SDP (Offer/Answer)</h4>
          <div style="margin-bottom: 8px;">
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="copyText('sdpBox')">복사</button>
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="pasteText('sdpBox')">붙여넣기</button>
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="clearText('sdpBox')">지우기</button>
          </div>
          <textarea id="sdpBox" style="background: #111; color: #0f0; padding: 10px; border: 1px solid #555; height: 120px;"></textarea>
        </div>
        <div class="col">
          <h4>Local ICE Candidates</h4>
          <div style="margin-bottom: 8px;">
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="copyText('localCandidatesBox')">복사</button>
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="pasteText('localCandidatesBox')">붙여넣기</button>
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="clearText('localCandidatesBox')">지우기</button>
          </div>
          <textarea id="localCandidatesBox" style="background: #111; color: #0f0; padding: 10px; border: 1px solid #555; height: 120px;"></textarea>
        </div>
        <div class="col">
          <h4>Remote ICE Candidates</h4>
          <div style="margin-bottom: 8px;">
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="copyText('remoteCandidatesBox')">복사</button>
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="pasteText('remoteCandidatesBox')">붙여넣기</button>
            <button class="btn-secondary" style="height: 32px; display: inline-flex; vertical-align: middle;" onclick="clearText('remoteCandidatesBox')">지우기</button>
          </div>
          <textarea id="remoteCandidatesBox" style="background: #111; color: #0f0; padding: 10px; border: 1px solid #555; height: 120px;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    const startCallBtn = document.getElementById('startCallBtn');
    const endCallBtn = document.getElementById('endCallBtn');
    const toggleCameraBtn = document.getElementById('toggleCameraBtn');
    const toggleAudioBtn = document.getElementById('toggleAudioBtn');

    const createOfferBtns = document.querySelectorAll('.createOffer');
    const createAnswerBtn = document.getElementById('createAnswer');
    const setRemoteAnswerBtn = document.getElementById('setRemoteAnswer');
    const addRemoteCandidatesBtn = document.getElementById('addRemoteCandidates');

    const sdpBox = document.getElementById('sdpBox');
    const localCandidatesBox = document.getElementById('localCandidatesBox');
    const remoteCandidatesBox = document.getElementById('remoteCandidatesBox');

    const configuration = { iceServers: [] };

    const statusElementMap = {
      local: document.getElementById('localStatus'),
      remote: document.getElementById('remoteStatus'),
    };

    let pc = null;
    let localStream = null;

    /**
     * 카메라/오디오 버튼 관련 상태 업데이트 함수
     */
    function updateCallButtons(inCall) {
      startCallBtn.disabled = inCall;
      endCallBtn.disabled = !inCall;
      toggleCameraBtn.disabled = !inCall;
      toggleAudioBtn.disabled = !inCall;
    }

    /**
     * RTCPeerConnection이 없으면 생성하고, 원격 스트림 처리와 ICE 후보 수집/전송을 설정하는 함수
     */
    function ensurePC() {
      if (!pc) {
        pc = new RTCPeerConnection(configuration);

        const remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;

        pc.ontrack = (event) => {
          event.streams[0].getTracks().forEach((t) => remoteStream.addTrack(t));

          applyStatusToDOM('remote', 'CONNECTED');
          applyStatusToDOM('local', 'CONNECTED');
        };

        // 로컬 ICE 후보: 수동 텍스트 + WS 전송 병행
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            localCandidatesBox.value += JSON.stringify(event.candidate) + '\n';
          }
        };

        pc.oniceconnectionstatechange = () => {
          console.log('ICE state:', pc.iceConnectionState);

          switch (pc.iceConnectionState) {
            case 'checking':
              applyStatusToDOM('remote', 'CONNECTING');
              break;
            case 'connected':
            case 'completed':
              applyStatusToDOM('local', 'CONNECTED');
              applyStatusToDOM('remote', 'CONNECTED');
              break;
            case 'failed':
              applyStatusToDOM('remote', 'ERROR', '연결 실패');
              break;
            case 'disconnected':
            case 'closed':
              applyStatusToDOM('remote', 'DISCONNECTED');
              endCall(); // 상대방 연결이 끊어지면 내 통화도 종료
              break;
          }
        };
      }
    }

    /**
     * 통화 연결
     */
    async function startCall() {
      try {
        // 권한 확인
        const cameraStatus = await navigator.permissions.query({ name: 'camera' });
        const microphoneStatus = await navigator.permissions.query({ name: 'microphone' });
        if (cameraStatus.state === 'denied') { alert('카메라 권한이 거부되었습니다.'); return; }
        if (microphoneStatus.state === 'denied') { alert('마이크 권한이 거부되었습니다.'); return; }

        // 미디어 장치 연결
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        // WebRTC 연결
        ensurePC();
        localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));

        // UX 상태 업데이트
        updateCallButtons(true);
        applyStatusToDOM('local', 'WAITING');
      } catch (e) {
        applyStatusToDOM('local', 'ERROR', e.message);
      }
    }
    
    /**
     * 통화 종료
     */
    function endCall() {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      localVideo.srcObject = null;
      remoteVideo.srcObject = null;

      applyStatusToDOM('local', 'DISCONNECTED');
      applyStatusToDOM('remote', 'DISCONNECTED'); 

      // UI 초기화
      sdpBox.value = '';
      localCandidatesBox.value = '';
      remoteCandidatesBox.value = '';

      updateCallButtons(false);
    }

    /**
     * 카메라 On/Off
     */
    function toggleCamera() {
      if (localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
          videoTrack.enabled = !videoTrack.enabled;
        }
      }
    }

    /**
     * 오디오 On/Off
     */
    function toggleAudio() {
      if (localStream) {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
          audioTrack.enabled = !audioTrack.enabled;
        }
      }
    }

    // Offer 생성: 수동/WS 병행
    async function handleCreateOffer() {
      try {
        ensurePC();

        applyStatusToDOM('local', 'CONNECTING');

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
    
        sdpBox.value = JSON.stringify(pc.localDescription);
      } catch (e) {
        applyStatusToDOM('local', 'ERROR', e.message);
      }
    };

    // Answer 생성: 수동/WS 병행
    async function handleCreateAnswer() {
      try {
        ensurePC();

        const remoteOffer = JSON.parse(sdpBox.value.trim());
        await pc.setRemoteDescription(new RTCSessionDescription(remoteOffer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
    
        sdpBox.value = JSON.stringify(pc.localDescription);
      } catch (e) {
        applyStatusToDOM('local', 'ERROR', e.message);
      }
    }

    // Remote Answer 수동 적용
    async function handleSetRemoteAnswer() {
      try {
        const remoteAnswer = JSON.parse(sdpBox.value.trim());
        await pc.setRemoteDescription(new RTCSessionDescription(remoteAnswer));
        alert('Remote Answer 적용 완료!');
      } catch (e) {
        applyStatusToDOM('local', 'ERROR', e.message);
      }
    }

    // Remote ICE candidates 수동 적용
    async function handleAddRemoteCandidates() {
      try {
        const lines = remoteCandidatesBox.value
          .split('\n')
          .map((l) => l.trim())
          .filter((l) => !!l);

        for (const line of lines) {
          const candidateObj = JSON.parse(line);
          await pc.addIceCandidate(new RTCIceCandidate(candidateObj));
        }
        alert('Remote ICE candidates 적용 완료!');
      } catch (e) {
        applyStatusToDOM('local', 'ERROR', e.message);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      // UX 상태 업데이트
      updateCallButtons(false);
      applyStatusToDOM('local', 'IDLE');
    });
  </script>
</body>
</html>
