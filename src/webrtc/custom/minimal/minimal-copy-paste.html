<!DOCTYPE html>
<html lang="ko">
<head>
  <script src="/src/webrtc/js/common/set-title.js"></script>
  <script src="/src/webrtc/js/common/utils.js"></script>
  <script src="/src/webrtc/js/common/CallManager.js"></script>
  <link rel="stylesheet" href="/src/webrtc/css/main.css">
</head>
<body>
  <div id="container">
    <div class="status-pill">
      <div><span id="statusText">접속</span></div>
    </div>

    <div class="split-container">
      <div class="video-box">
        <div class="label">상대방 (Remote)</div>
        <video id="remoteVideo" autoplay playsinline></video>
      </div>
      <div class="video-box">
        <div class="label">나 (Local)</div>
        <video id="localVideo" autoplay playsinline muted></video>
      </div>

      <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">연결중</div>
        <div id="countdownText" class="countdown-text"></div>
      </div>
    </div>

    <div class="control-bar">
      <button id="startCallBtn" class="btn-primary" onclick="document.getElementById('manualPanel').style.display = 'block'">수동 통화 시작</button>
      <button id="endCallBtn" class="btn-danger" onclick="endCall()" style="display:none">통화 종료</button>
      <button id="toggleCameraBtn" class="btn-secondary" onclick="callManager.toggleMedia('video')" style="display:none">카메라 On</button>
      <button id="toggleAudioBtn" class="btn-secondary" onclick="callManager.toggleMedia('audio')" style="display:none">마이크 On</button>
      <button id="retryBtn" class="btn-primary" onclick="init()" style="display:none">다시 연결</button>
    </div>

    <div id="manualPanel" class="panel" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; background: rgba(32, 33, 36, 0.95); color: #fff; z-index: 1;">
      <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; margin-bottom: 15px; padding-bottom: 10px;">
        <h3 style="margin: 0;">수동 WebRTC 연결 방법</h3>
        <button class="btn-small" onclick="document.getElementById('manualPanel').style.display = 'none'">닫기</button>
      </div>
      
      <p class="sub-text" style="color: #aaa;">
        - A에서 “Create Offer” 클릭 → A의 SDP에 Offer 텍스트 생성 및 복사<br/>
        - A의 SDP Offer → B의 SDP에 붙여넣고 “Create Answer” 클릭 → B의 SDP에 Answer 텍스트 생성 및 복사<br/>
        - B의 SDP Answer → A의 SDP에 붙여넣고 “Set Remote Answer” 클릭 → A의 ICE Candidates에 텍스트 생성 및 복사<br/>
        - A의 ICE Candidates → B의 Remote ICE Candidates에 붙여넣고 “Add Remote ICE Candidates” 클릭<br/>
      </p>

      <div class="row">
        <button id="createOffer" class="btn-primary" onclick="handleCreateOffer()">Create Offer</button>
        <button id="createAnswer" class="btn-primary" onclick="handleCreateAnswer()">Create Answer</button>
        <button id="setRemoteAnswer" class="btn-primary" onclick="handleSetRemoteAnswer()">Set Remote Answer</button>
        <button id="addRemoteCandidates" class="btn-primary" onclick="handleAddRemoteCandidates()">Add Remote ICE Candidates</button>
      </div>

      <div class="row">
        <div class="col">
          <h4>SDP (Offer/Answer)</h4>
          <div style="margin-bottom: 8px;">
            <button class="btn-secondary" onclick="copyText('sdpBox')">복사</button>
            <button class="btn-secondary" onclick="pasteText('sdpBox')">붙여넣기</button>
            <button class="btn-secondary" onclick="clearText('sdpBox')">지우기</button>
          </div>
          <textarea id="sdpBox" style="height: 120px; background: #111; color: #0f0;"></textarea>
        </div>
        <div class="col">
          <h4>Local ICE Candidates</h4>
          <div style="margin-bottom: 8px;">
            <button class="btn-secondary" onclick="copyText('localCandidatesBox')">복사</button>
            <button class="btn-secondary" onclick="pasteText('localCandidatesBox')">붙여넣기</button>
            <button class="btn-secondary" onclick="clearText('localCandidatesBox')">지우기</button>
          </div>
          <textarea id="localCandidatesBox" style="height: 120px; background: #111; color: #0f0;"></textarea>
        </div>
        <div class="col">
          <h4>Remote ICE Candidates</h4>
          <div style="margin-bottom: 8px;">
            <button class="btn-secondary" onclick="copyText('remoteCandidatesBox')">복사</button>
            <button class="btn-secondary" onclick="pasteText('remoteCandidatesBox')">붙여넣기</button>
            <button class="btn-secondary" onclick="clearText('remoteCandidatesBox')">지우기</button>
          </div>
          <textarea id="remoteCandidatesBox" style="height: 120px; background: #111; color: #0f0;"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sdpBox = document.getElementById('sdpBox');
    const localCandidatesBox = document.getElementById('localCandidatesBox');
    const remoteCandidatesBox = document.getElementById('remoteCandidatesBox');

    const callManager = new CallManager(
      window.CONFIG,
      (state) => updateUi(state),
      (candidate) => {
        localCandidatesBox.value += JSON.stringify(candidate) + '\n';
      }
    );
    window.callManager = callManager;

    function updateUi(state) {
      document.getElementById('statusText').textContent = CALL_STATUS[state].label;
      const btns = ['startCallBtn', 'endCallBtn', 'toggleCameraBtn', 'toggleAudioBtn', 'retryBtn'];
      btns.forEach(id => document.getElementById(id).style.display = 'none');
      // 통화를 거는 쪽(caller)일 때만 연결중 로딩바 표시
      const showLoading = (state === CALL_STATUS.CONNECTING.id && callManager.role === 'caller');
      document.getElementById('loadingOverlay').style.display = showLoading ? 'flex' : 'none';

      if (state === CALL_STATUS.IDLE.id || state === CALL_STATUS.WAITING.id) {
        ['startCallBtn', 'toggleCameraBtn', 'toggleAudioBtn'].forEach(id => document.getElementById(id).style.display = 'block');
      } else if (state === CALL_STATUS.CONNECTING.id || state === CALL_STATUS.CONNECTED.id) {
        ['endCallBtn', 'toggleCameraBtn', 'toggleAudioBtn'].forEach(id => document.getElementById(id).style.display = 'block');
      } else if (state === CALL_STATUS.ERROR.id) {
        document.getElementById('retryBtn').style.display = 'block';
      }
    }

    async function handleCreateOffer() {
      try {
        callManager.state = window.CALL_STATUS.CONNECTING.id;
        callManager.ensurePC(document.getElementById('remoteVideo'));
        const offer = await callManager.createOffer();
        sdpBox.value = JSON.stringify(offer);
        document.getElementById('manualPanel').style.display = 'none';
      } catch (e) {
        handleError(e);
      }
    }

    async function handleCreateAnswer() {
      try {
        callManager.state = window.CALL_STATUS.CONNECTING.id;
        callManager.ensurePC(document.getElementById('remoteVideo'));
        const remoteOffer = JSON.parse(sdpBox.value.trim());
        const answer = await callManager.handleOffer(remoteOffer);
        sdpBox.value = JSON.stringify(answer);
      } catch (e) {
        handleError(e);
      }
    }

    async function handleSetRemoteAnswer() {
      try {
        const remoteAnswer = JSON.parse(sdpBox.value.trim());
        await callManager.handleAnswer(remoteAnswer);
        alert('Remote Answer 적용 완료!');
      } catch (e) {
        handleError(e);
      }
    }

    async function handleAddRemoteCandidates() {
      try {
        const lines = remoteCandidatesBox.value.split('\n').filter(l => l.trim());
        for (const line of lines) {
          await callManager.addIceCandidate(JSON.parse(line));
        }
        alert('Remote ICE candidates 적용 완료!');
      } catch (e) {
        handleError(e);
      }
    }

    function endCall() {
      const state = callManager.state;
      const isConnectionAttempt = (state === CALL_STATUS.CONNECTING.id || state === CALL_STATUS.ERROR.id);
      
      callManager.stopTimeout();
      callManager.closePC();

      if (isConnectionAttempt) {
        callManager.state = CALL_STATUS.IDLE.id;
      } else {
        callManager.stopMedia();
        document.getElementById('localVideo').srcObject = null;
        document.getElementById('remoteVideo').srcObject = null;
        callManager.state = CALL_STATUS.DISCONNECTED.id;
      }
      updateUi(callManager.state);

      sdpBox.value = '';
      localCandidatesBox.value = '';
      remoteCandidatesBox.value = '';
    }

    async function init() {
      try {
        await callManager.getMediaStream(document.getElementById('localVideo'));
        callManager.state = CALL_STATUS.IDLE.id;
      } catch (e) {
        callManager.state = window.CALL_STATUS.ERROR.id;
        handleError(e, init);
      }
      updateUi(callManager.state);
    }

    window.onload = init;
    window.onbeforeunload = endCall;
  </script>
</body>
</html>
